<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<title>Magic Bubble Pond</title>
<style>
  html, body {
    margin: 0;
    padding: 0;
    overflow: hidden;
    background: linear-gradient(#66ccff, #003366);
    height: 100%;
    width: 100%;
    touch-action: none;
  }
  canvas {
    display: block;
    position: fixed;
    top: 0;
    left: 0;
  }
</style>
</head>
<body>
<canvas id="pond"></canvas>
<script>
const canvas = document.getElementById('pond');
const ctx = canvas.getContext('2d');
let bubbles = [];
let animals = [
  {emoji:'ðŸŸ', name:'fish'},
  {emoji:'ðŸ¦‹', name:'butterfly'},
  {emoji:'ðŸ¢', name:'turtle'},
  {emoji:'ðŸ¦€', name:'crab'},
  {emoji:'ðŸ ', name:'tropical fish'},
  {emoji:'ðŸ¸', name:'frog'},
  {emoji:'ðŸ¤', name:'chick'}
];
const dino = {emoji:'ðŸ¦–', name:'dinosaur', rare:true, color:'#ffd700', sound:new Audio('https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg')};
const popSound = new Audio('https://actions.google.com/sounds/v1/cartoon/pop.ogg');

let availableVoices = [];
function loadVoices() {
  availableVoices = speechSynthesis.getVoices();
  if (availableVoices.length === 0) {
    speechSynthesis.onvoiceschanged = () => {
      availableVoices = speechSynthesis.getVoices();
    };
  }
}
loadVoices();

document.body.addEventListener('click', () => {}, {once: true});

function resizeCanvas() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener('resize', resizeCanvas);
window.addEventListener('orientationchange', resizeCanvas);
resizeCanvas();

function randomColor() {
  const colors = ['#ff9999','#ffcc99','#ffff99','#ccff99','#99ffcc','#99ccff','#cc99ff'];
  return colors[Math.floor(Math.random() * colors.length)];
}

class Bubble {
  constructor(x, y, radius) {
    this.x = x;
    this.y = y;
    this.radius = radius;
    // 1 in 50 chance for rare dino
    if (Math.random() < 1/50) {
      this.color = dino.color;
      this.animal = dino.emoji;
      this.animalName = dino.name;
      this.isRare = true;
    } else {
      this.color = randomColor();
      let animalObj = animals[Math.floor(Math.random() * animals.length)];
      this.animal = animalObj.emoji;
      this.animalName = animalObj.name;
      this.isRare = false;
    }
    this.vy = - (0.3 + Math.random() * 0.5);
    this.vx = (Math.random() - 0.5) * 0.5;
    this.popped = false;
    this.popAnimProgress = 0;
    this.animalY = y;
    this.animalVy = 0;
    this.shards = [];
  }
  update() {
    if (!this.popped) {
      this.x += this.vx;
      this.y += this.vy;
    } else {
      if (this.popAnimProgress < 1) {
        this.popAnimProgress += 0.08;
        for (let s of this.shards) {
          s.x += s.vx;
          s.y += s.vy;
          s.vy += 0.05;
        }
      } else {
        this.animalY += this.animalVy;
        this.animalVy += 0.15;
      }
    }
  }
  draw() {
    if (!this.popped) {
      ctx.beginPath();
      ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
      ctx.fillStyle = this.color;
      ctx.fill();
      ctx.globalAlpha = 0.3;
      ctx.strokeStyle = '#ffffff';
      ctx.lineWidth = 2;
      ctx.stroke();
      ctx.globalAlpha = 1.0;

      ctx.save();
      ctx.filter = 'grayscale(100%) blur(5px)';
      ctx.font = `${this.radius}px sans-serif`;
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(this.animal, this.x, this.y);
      ctx.restore();
    } else {
      if (this.popAnimProgress < 1) {
        let ringScale = 1 + this.popAnimProgress * 0.6;
        ctx.globalAlpha = 1 - this.popAnimProgress;
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.radius * ringScale, 0, Math.PI * 2);
        ctx.lineWidth = 4;
        ctx.strokeStyle = this.color;
        ctx.stroke();
        ctx.globalAlpha = 1.0;
        ctx.fillStyle = this.color;
        for (let s of this.shards) {
          ctx.beginPath();
          ctx.arc(s.x, s.y, s.size, 0, Math.PI * 2);
          ctx.fill();
        }
      } else {
        ctx.font = `${this.radius}px sans-serif`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(this.animal, this.x, this.animalY);
      }
    }
  }
}

function createBubble(x, y, size = 100) {
  bubbles.push(new Bubble(x, y, size));
}

function animate() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  for (let i = bubbles.length - 1; i >= 0; i--) {
    const b = bubbles[i];
    b.update();
    b.draw();
    if (b.y + b.radius < 0 && !b.popped) {
      bubbles.splice(i, 1);
    }
    if (b.animalY > canvas.height && b.popped && b.popAnimProgress >= 1) {
      bubbles.splice(i, 1);
    }
  }
  requestAnimationFrame(animate);
}

function speakAnimal(name) {
  if ('speechSynthesis' in window && availableVoices.length > 0) {
    const utterance = new SpeechSynthesisUtterance(name);
    utterance.pitch = 1;
    utterance.rate = 1;
    utterance.voice = availableVoices.find(v => v.name.toLowerCase().includes('female')) || availableVoices[0];
    speechSynthesis.speak(utterance);
  }
}

function popBubble(x, y) {
  for (let i = 0; i < bubbles.length; i++) {
    let b = bubbles[i];
    let dx = x - b.x;
    let dy = y - b.y;
    if (!b.popped && Math.sqrt(dx*dx + dy*dy) <= b.radius) {
      b.popped = true;
      b.popAnimProgress = 0;
      b.animalY = b.y;
      b.animalVy = -2;
      b.shards = [];
      for (let s = 0; s < 8; s++) {
        b.shards.push({
          x: b.x,
          y: b.y,
          vx: Math.cos((s / 8) * Math.PI * 2) * (1.5 + Math.random()),
          vy: Math.sin((s / 8) * Math.PI * 2) * (1.5 + Math.random()),
          size: Math.random() * 4 + 2
        });
      }
      if (b.isRare) {
        dino.sound.currentTime = 0;
        dino.sound.play().catch(()=>{});
      } else {
        popSound.currentTime = 0;
        popSound.play().catch(()=>{});
      }
      speakAnimal(b.animalName);
      return true;
    }
  }
  return false;
}

let growingBubbles = {};

function startBubble(id, x, y) {
  growingBubbles[id] = {x, y, size: 50};
}

function growBubble(id) {
  if (growingBubbles[id]) {
    growingBubbles[id].size += 2.5;
  }
}

function releaseBubble(id) {
  if (growingBubbles[id]) {
    createBubble(growingBubbles[id].x, growingBubbles[id].y, growingBubbles[id].size);
    delete growingBubbles[id];
  }
}

function getPointerPos(e) {
  if (e.touches && e.touches.length > 0) {
    return {x: e.touches[0].clientX, y: e.touches[0].clientY};
  } else {
    return {x: e.clientX, y: e.clientY};
  }
}

canvas.addEventListener('pointerdown', e => {
  const pos = getPointerPos(e);
  if (!popBubble(pos.x, pos.y)) {
    startBubble(e.pointerId, pos.x, pos.y);
  }
});
canvas.addEventListener('pointermove', e => {
  growBubble(e.pointerId);
});
canvas.addEventListener('pointerup', e => {
  releaseBubble(e.pointerId);
});
canvas.addEventListener('pointercancel', e => {
  releaseBubble(e.pointerId);
});

animate();
</script>
</body>
</html>
